<div class="container mt-4">
  <div class="row">
    <div class="col-md-3">
      <div class="filter-card p-3">
        <h5>Filters</h5>
        <div class="mb-2">
          <label class="form-label">Search</label>
          <input class="form-control" [(ngModel)]="q" (ngModelChange)="applyFilters()" placeholder="Search by title or author" aria-label="Search books" />
        </div>
        <div class="mb-2">
          <label class="form-label">Price range</label>
          <div class="range-slider-wrapper">
            <div class="range-slider">
              <input class="range-input" type="range" min="0" max="100" [(ngModel)]="minPrice" (ngModelChange)="onSliderChange($event,'min')" aria-label="Minimum price" />
              <input class="range-input" type="range" min="0" max="100" [(ngModel)]="maxPrice" (ngModelChange)="onSliderChange($event,'max')" aria-label="Maximum price" />
              <div class="range-labels"><span class="range-label-min">{{ priceMin | currency }}</span><span class="range-label-max">{{ priceMax | currency }}</span></div>
            </div>
          </div>
        </div>
        <div *ngIf="hasActiveFilters()" class="active-filters">
          <button class="btn btn-sm btn-outline-secondary me-2" (click)="clearFilters()">Clear</button>
        </div>
      </div>
    </div>

    <div class="col-md-9">
      <div *ngIf="loading">
        <app-loading-skeleton type="card"></app-loading-skeleton>
      </div>

      <div *ngIf="!loading && products.length === 0" class="text-center py-4">
        <p class="lead">No books found.</p>
        <p>Try adjusting your filters or <a routerLink="/books">view all books</a>.</p>
      </div>

      <div *ngIf="!loading && products.length>0" class="row g-3">
        <div *ngFor="let p of products" class="col-6 col-md-4">
          <mat-card class="product-card" role="article" tabindex="0" (click)="addToCart(p)">
            <button mat-icon-button color="warn" class="wishlist-btn" aria-label="Toggle wishlist" (click)="toggleWishlist(p,$event)">
              <mat-icon>{{ wishlist.has(p.id) ? 'favorite' : 'favorite_border' }}</mat-icon>
            </button>
            <img [src]="p.imageUrl || 'assets/book-placeholder.svg'" (error)="onImgError($event)" loading="lazy" alt="{{p.title}} cover" class="product-image" />
            <mat-card-content>
              <div class="title">{{ p.title }}</div>
              <div class="author text-muted small">{{ p.authors }}</div>
              <div class="price-tag">{{ p.price | currency }}</div>
              <div class="stock-info" *ngIf="p.stock>0">In stock: {{p.stock}}</div>
              <div class="stock-info text-danger" *ngIf="p.stock===0">Out of stock</div>
            </mat-card-content>
          </mat-card>
        </div>
      </div>

      <div *ngIf="!loading && totalPages>1" class="mt-3">
        <nav aria-label="Product pages">
          <ul class="pagination justify-content-center">
            <li class="page-item" [class.disabled]="page===1"><button class="page-link" (click)="goto(page-1)">Previous</button></li>
            <li *ngFor="let p of visiblePages" class="page-item" [class.active]="p===page"><button class="page-link" (click)="goto(p)">{{p}}</button></li>
            <li class="page-item" [class.disabled]="page===totalPages"><button class="page-link" (click)="goto(page+1)">Next</button></li>
          </ul>
        </nav>
      </div>

    </div>
  </div>
</div>
